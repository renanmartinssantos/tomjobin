<!doctype html>
<html lang="pt-BR">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Upload LinkedIn ZIP</title>
		<!-- Tailwind via CDN for fast prototyping -->
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			html, body { height: 100%; margin: 0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #f4f6fb; color: #223; }
			.container { max-width: 1100px; margin: 24px auto; padding: 20px; }
			.header { display: flex; gap: 20px; align-items: center; justify-content: space-between; }
			.brand { display:flex; gap:12px; align-items:center; }
			.logo { width:150px; height:100px; border-radius:8px; display:inline-block; }
			h1 { margin:0; font-size:18px; }
			.card { background:#fff; border-radius:12px; padding:18px; box-shadow:0 6px 22px rgba(15,23,42,0.06); }
			.form-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
			.file-input { flex:1; min-width:220px; }
			button.primary { background:#2563eb; color:#fff; border:none; padding:10px 16px; border-radius:10px; cursor:pointer; }
			button.primary[disabled]{ opacity:0.6; cursor:not-allowed }
			.hint { color:#6b7280; font-size:13px; }

			.results-area { margin-top:18px; display:grid; gap:18px; }
			.jobs-list { display:flex; flex-direction:column; gap:12px; }
			.job-card { display:flex; gap:12px; align-items:flex-start; padding:12px; border-radius:10px; background: linear-gradient(180deg,#ffffff, #fbfdff); border:1px solid #eef2ff; }
			.job-meta { flex:1; }
			.job-title { font-weight:600; margin:0 0 6px 0; }
			.job-company { margin:0; color:#6b7280; font-size:13px }
			.score { min-width:80px; text-align:right; font-weight:700; color:#0f172a }
			.progress { height:8px; background:#eef2ff; border-radius:6px; overflow:hidden; margin-top:8px }
			.progress > i { display:block; height:100%; background:linear-gradient(90deg,#34d399,#60a5fa); width:0%; }

			/* graph area below list */
			.graph-wrap { margin-top:16px; height:560px; background:#fff; border-radius:10px; overflow:hidden; border:1px solid #e6eefc }
			.graph-iframe { width:100%; height:100%; border:0; }

			@media(min-width:900px){ .form-row { flex-wrap:nowrap } .job-card{ align-items:center } }

			/* Modal styles for insight modal (fade + scroll) */
			.insight-overlay { position: fixed; left:0; top:0; right:0; bottom:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.45); z-index:9999; opacity:0; transition: opacity .18s ease; }
			.insight-overlay.show { display:flex; opacity:1; }
			.insight-inner { max-width:820px; width:92%; background:#fff; padding:18px; border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,0.12); transform: translateY(10px) scale(.98); opacity:0; transition: opacity .18s ease, transform .18s ease; }
			.insight-overlay.show .insight-inner { transform: translateY(0) scale(1); opacity:1; }
			.insight-content { max-height: 70vh; overflow:auto; }
		</style>
	</head>
	<body>
		<div class="container">
			<!-- central loading overlay (hidden by default) -->
			<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
				<div class="bg-white p-6 rounded-lg shadow flex items-center gap-4">
					<svg class="w-8 h-8 animate-spin text-sky-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
					<div class="text-slate-700 font-medium">Carregando, por favor aguarde...</div>
				</div>
			</div>
			<div class="header">
					<div class="brand">
						<span class="logo"><img src="/assets/img/logojobin.png" alt="Jobin" style="width:150px;height:100px;display:block;border-radius:8px;object-fit:contain;"/></span>
					<!-- <div>
						<h1>Processador de Export LinkedIn</h1>
						<div class="hint">Envie seu .zip e visualize vagas e grafo de tokens.</div>
					</div> -->
					</div>
					<div style="min-width:280px">
						<div class="card">
							<form id="uploadForm">
                                <div class="hint">Upload do arquivo Backup .zip do Linkedin</div>
								<div class="form-row">
									<input id="fileInput" class="file-input" name="file" type="file" accept=".zip" />
									<button id="submitBtn" class="primary" type="submit">Enviar</button>
								</div>
								<!-- <div class="hint">Rota usada: <code>/upload_linkedin_zip</code></div> -->
							</form>
						</div>
					</div>
				</div>

				<div class="results-area">
					<div class="card">
						<h2 style="margin:0 0 8px 0">Vagas encontradas</h2>
						<p class="hint">A lista aparece vazia até que um arquivo seja enviado.</p>
						<div id="jobsList" class="jobs-list" aria-live="polite"></div>
					</div>

					<div id="graphContainer" class="card graph-wrap" style="display:none">
						<iframe id="graphIframe" class="graph-iframe"></iframe>
					</div>

					<!-- raw JSON result (hidden until filled) -->
					<div id="rawResult" class="card mt-4" style="display:none">
						<h3 class="text-sm font-medium">Resultado (raw)</h3>
						<pre id="resultDump" class="text-xs overflow-auto" style="max-height:320px; white-space:pre-wrap; margin-top:8px;"></pre>
					</div>
				</div>
		</div>

		<script>
			const form = document.getElementById('uploadForm');
			const fileInput = document.getElementById('fileInput');
			const submitBtn = document.getElementById('submitBtn');
			const jobsList = document.getElementById('jobsList');
			const graphContainer = document.getElementById('graphContainer');
			const graphIframe = document.getElementById('graphIframe');

			// global helper to show insight modal (created on demand)
			function showInsight(resp){
				let modal = document.getElementById('insightModal');
								if (!modal) {
										modal = document.createElement('div');
										modal.id = 'insightModal';
										modal.innerHTML = `
										<div id='insightOverlay' class='insight-overlay'>
											<div class='insight-inner'>
												<div style='display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;'>
													<h3 style='margin:0;font-size:18px;font-weight:600'>Insight da vaga</h3>
													<button id='insightClose' style='background:transparent;border:0;font-size:22px;cursor:pointer'>&times;</button>
												</div>
												<div id='insightContent' class='insight-content' style='font-size:14px;color:#111'></div>
											</div>
										</div>`;
										document.body.appendChild(modal);
								}

				const modalRoot = modal;
				const overlay = modalRoot ? modalRoot.querySelector('#insightOverlay') : null;
				const content = modalRoot ? modalRoot.querySelector('#insightContent') : null;
				const closeBtn = modalRoot ? modalRoot.querySelector('#insightClose') : null;
				if (!overlay || !content) return;

				// ensure modal wrapper is visible
				modalRoot.style.display = 'block';

				// show with CSS animation
				overlay.classList.add('show');

				// handle close (fade out then hide)
				const hideModal = () => { overlay.classList.remove('show'); setTimeout(()=>{ modalRoot.style.display = 'none'; }, 220); };
				if (closeBtn) { closeBtn.onclick = hideModal; }
				// click outside to close
				overlay.onclick = function(e){ if (e.target === overlay) { hideModal(); } };

				// render structured JSON if available
				if (resp && resp.analysis) {
					const a = resp.analysis;
					let html = '';
					if (Array.isArray(a.strengths) || a.strengths) {
						html += '<h4 style="margin:6px 0 4px 0;font-weight:600">Pontos fortes</h4><ul style="margin:0 0 8px 18px">';
						const arr = Array.isArray(a.strengths) ? a.strengths : [a.strengths];
						arr.slice(0,6).forEach(it=> html += `<li>${it}</li>`);
						html += '</ul>';
					}
					if (Array.isArray(a.benefits) || a.benefits) {
						html += '<h4 style="margin:6px 0 4px 0;font-weight:600">Benefícios / cultura</h4>';
						if (Array.isArray(a.benefits)) { html += '<ul style="margin:0 0 8px 18px">'; a.benefits.slice(0,6).forEach(it=> html += `<li>${it}</li>`); html += '</ul>'; }
						else { html += `<div>${a.benefits}</div>` }
					}
					if (Array.isArray(a.gaps) || a.gaps) {
						html += '<h4 style="margin:6px 0 4px 0;font-weight:600">Gaps</h4><ul style="margin:0 0 8px 18px">';
						const arr = Array.isArray(a.gaps) ? a.gaps : [a.gaps];
						arr.slice(0,6).forEach(it=> html += `<li>${it}</li>`);
						html += '</ul>';
					}
					if (Array.isArray(a.recommendations) || a.recommendations) {
						html += '<h4 style="margin:6px 0 4px 0;font-weight:600">Recomendações</h4><ul style="margin:0 0 8px 18px">';
						const arr = Array.isArray(a.recommendations) ? a.recommendations : [a.recommendations];
						arr.slice(0,6).forEach(it=> html += `<li>${it}</li>`);
						html += '</ul>';
					}
					if (a.summary) html += '<h4 style="margin:6px 0 4px 0;font-weight:600">Resumo</h4><div>' + a.summary + '</div>';
					content.innerHTML = html;
					return;
				}
				// fallback: show analysis_text
				if (resp && resp.analysis_text) {
					content.innerText = resp.analysis_text;
					return;
				}
				content.innerText = JSON.stringify(resp, null, 2);
			}

			function clearJobs() {
				jobsList.innerHTML = '';
				graphContainer.style.display = 'none';
				graphIframe.src = '';
			}

			function makeJobCard(job, scorePercent, idx) {
				const div = document.createElement('div');
				div.className = 'job-card flex items-center gap-4';

				// left: company icon
				const iconWrap = document.createElement('div');
				iconWrap.className = 'w-24 h-12 flex-shrink-0 rounded-full bg-slate-100 overflow-hidden flex items-center justify-center';
				const img = document.createElement('img');
				img.className = 'w-24 h-12 object-cover';
				// choose possible icon fields or derive favicon from website
				let iconUrl = job.company_logo || job.logo || job.company_image || job.company_icon || job.image || job.company_logo_url || null;
				if (!iconUrl) {
					// try to derive from company_website or job_url
					const maybe = job.company_website || job.company_url || job.job_url || job.url || job.link;
					try {
						if (maybe) {
							const u = new URL(maybe, window.location.href);
							iconUrl = u.origin + '/favicon.ico';
						}
					} catch(e) { iconUrl = null; }
				}
				if (iconUrl) {
					img.src = iconUrl;
					img.alt = (job.company || 'company') + ' logo';
					img.onerror = () => { img.style.display = 'none'; };
				} else {
					img.style.display = 'none';
				}
				iconWrap.appendChild(img);

				const meta = document.createElement('div');
				meta.className = 'job-meta flex-1 min-w-0';
				const title = document.createElement('div');
				title.className = 'job-title text-sm text-slate-900 truncate font-semibold';
				title.textContent = job.title || job.position || job.role || job.job_title || `Vaga ${idx+1}`;
				const comp = document.createElement('p');
				comp.className = 'job-company text-xs text-slate-500 truncate';
				const company = job.company || job.company_name || job.source || '';
				const location = job.location || job.city || job.region || '';
				comp.textContent = [company, location].filter(Boolean).join(' · ');
				meta.appendChild(title);
				meta.appendChild(comp);

				const right = document.createElement('div');
				right.className = 'score flex-shrink-0 text-right';
				const perc = document.createElement('div');
				perc.className = 'text-sm font-semibold text-slate-900';
				perc.textContent = `${scorePercent}%`;
				const bar = document.createElement('div');
				bar.className = 'progress mt-2 w-28 bg-slate-100 rounded-full h-2 overflow-hidden';
				const inner = document.createElement('i');
				inner.style.width = `${scorePercent}%`;
				inner.className = 'block h-2 bg-gradient-to-r from-emerald-400 to-sky-500';
				bar.appendChild(inner);
				right.appendChild(perc);
				right.appendChild(bar);

				// optional link button if url present
				if (job.job_url || job.url || job.link) {
					const a = document.createElement('a');
					a.href = job.job_url || job.url || job.link;
					a.target = '_blank';
					a.rel = 'noopener noreferrer';
					a.className = 'text-xs text-sky-600 hover:underline mt-2 block';
					a.textContent = 'Abrir vaga';
					right.appendChild(a);
				}

				div.appendChild(iconWrap);
				div.appendChild(meta);
				// insight button (lightbulb) - shows analysis modal
				const insightBtn = document.createElement('button');
				insightBtn.className = 'ml-3 text-yellow-500 hover:text-yellow-600';
				insightBtn.title = 'Analisar adequação';
				insightBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 10-2 0v1a4 4 0 00-3 6.65V12a1 1 0 001 1h6a1 1 0 001-1v-1.35A4 4 0 0011 4V3z"/><path d="M5 16a3 3 0 006 0H5z"/></svg>';

						insightBtn.addEventListener('click', async (e) => {
							// build minimal payload: user_token and job {adamic_adar, description}
							e.preventDefault();
							const payload = window.latestPayload || {};
							const user_token = payload.user_token || {};
							let desc = job.description || job.job_description || job.description_text || job.description_token || '';
							if (Array.isArray(desc)) desc = desc.join(' ');
							const jobPayload = { adamic_adar: job.adamic_adar ?? job.score ?? job.similarity ?? 0, description: desc, title: job.title || job.position || '' };
							insightBtn.disabled = true;
							const originalHTML = insightBtn.innerHTML;
							insightBtn.innerHTML = '…';
							try {
								const resp = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user_token: user_token, job: jobPayload }) });
								// if server returned non-JSON (like a 500 HTML page), attempt to read text and show it
								if (!resp.ok) {
									let txt;
									try { txt = await resp.text(); } catch(e){ txt = `HTTP ${resp.status}`; }
									showInsight({ analysis_text: `Erro do servidor: HTTP ${resp.status}.\n${txt}` });
									return;
								}
								let j;
								try {
									j = await resp.json();
								} catch (e) {
									// fallback to text
									let txt = '';
									try { txt = await resp.text(); } catch (er) { txt = String(er); }
									showInsight({ analysis_text: txt });
									return;
								}
								// success
								showInsight(j);
							} catch (err) {
								console.error('insight err', err);
								showInsight({ analysis_text: 'Falha de rede ao chamar /api/chat: ' + String(err) });
							} finally {
								insightBtn.disabled = false;
								insightBtn.innerHTML = originalHTML;
							}
						});

				// add insight button next to right area
				const rightWrap = document.createElement('div');
				rightWrap.className = 'flex items-center gap-2';
				rightWrap.appendChild(right);
				rightWrap.appendChild(insightBtn);
				div.appendChild(rightWrap);
				return div;
			}

			form.addEventListener('submit', async (ev) => {
				ev.preventDefault();
				clearJobs();
				const loadingOverlay = document.getElementById('loadingOverlay');
				function showLoading(v){ if(v) loadingOverlay.classList.remove('hidden'); else loadingOverlay.classList.add('hidden'); }

				const file = fileInput.files[0];
				if (!file) {
					const p = document.createElement('div');
					p.className = 'job-card';
					p.textContent = 'Por favor selecione um arquivo .zip antes de enviar.';
					jobsList.appendChild(p);
					return;
				}

				submitBtn.disabled = true;
				submitBtn.textContent = 'Enviando...';
				showLoading(true);

				try {
					const formData = new FormData();
					formData.append('file', file);
					const resp = await fetch('/upload_linkedin_zip', { method: 'POST', body: formData });
					const txt = await resp.text();
					let parsed = null;
					try { parsed = JSON.parse(txt); } catch(e) { parsed = null; }
					// show raw result JSON below the list (hidden container)
					const resultDump = document.getElementById('resultDump');
					if (resultDump) {
						try {
							resultDump.textContent = parsed ? JSON.stringify(parsed, null, 2) : txt;
							resultDump.parentElement.style.display = (parsed || txt) ? 'block' : 'none';
						} catch (e) { /* ignore display errors */ }
					}
					if (!resp.ok) {
						const errMsg = parsed && parsed.error ? parsed.error : txt;
						const ecard = document.createElement('div'); ecard.className='job-card'; ecard.textContent = 'Erro: ' + errMsg; jobsList.appendChild(ecard);
						return;
					}

					// use jobs_token as the single source of truth (server now returns only user_token and jobs_token)
					const jobs = parsed && Array.isArray(parsed.jobs_token) ? parsed.jobs_token : [];
					const jt = jobs; // tokens/metadata are included in the same array

					// expose payload globally for insight button handlers
					window.latestPayload = parsed || {};

					// helper to find matching token record for a given job (best-effort)
					function findJtForJob(job, idx){
						if (!jt || jt.length===0) return null;
						if (jt[idx]) return jt[idx];
						const keys = ['id','job_url','job_url_direct','url','company','title'];
						for (const cand of jt){
							for (const k of ['id','job_url','job_url_direct','url']){
								if (cand && cand[k] && job && (job[k] && String(cand[k])===String(job[k]))) return cand;
							}
						}
						return jt[idx] || null;
					}

					// render jobs incrementally to avoid UI freezes / blob issues
					if (!jobs || jobs.length === 0) {
						const p = document.createElement('div'); p.className='job-card'; p.textContent = 'Nenhuma vaga encontrada.'; jobsList.appendChild(p);
						showLoading(false);
					} else {
						let i = 0;
						const batchMs = 140; // ms between items
						const timer = setInterval(()=>{
							if (i >= jobs.length) {
								clearInterval(timer);
								// after list rendered, load graph with a short delay
								setTimeout(()=>{
									// prefer not to embed the HTML in JSON; server returns a URL in parsed.jobs_graph_url
									if (parsed && parsed.jobs_graph_url) {
										try {
											const graphUrl = (parsed.jobs_graph_url.startsWith('http') ? parsed.jobs_graph_url : (location.origin + parsed.jobs_graph_url));
											const linkCard = document.createElement('div');
											linkCard.className = 'job-card flex items-center justify-center';
											const a = document.createElement('a');
											a.href = graphUrl;
											a.target = '_blank';
											a.rel = 'noopener noreferrer';
											a.className = 'text-sm font-semibold text-sky-600 hover:underline';
											a.textContent = 'Clique aqui para ver o seu grafo (nova janela)';
											linkCard.appendChild(a);
											// insert at top of jobsList
											if (jobsList.firstChild) jobsList.insertBefore(linkCard, jobsList.firstChild);
											else jobsList.appendChild(linkCard);
										} catch(e) { console.warn('Falha ao criar link do grafo', e); }
									}
									showLoading(false);
								}, 200);
								return;
							}
							const job = jobs[i];
							const jtMatch = findJtForJob(job, i);
							let scoreRaw = 0;
							if (jtMatch) scoreRaw = jtMatch.adamic_adar ?? jtMatch.score ?? jtMatch.similarity ?? 0;
							let scoreNum = Number(scoreRaw) || 0;
							let percent = Math.round(scoreNum * 100);
							if (percent > 100) percent = 100; if (percent < 0) percent = 0;
							const card = makeJobCard(job, percent, i);
							jobsList.appendChild(card);

							// (showInsight is now a global helper)
							i += 1;
						}, batchMs);
					}
				} catch (err) {
					const ecard = document.createElement('div'); ecard.className='job-card'; ecard.textContent = 'Falha ao enviar: ' + (err && err.message ? err.message : String(err)); jobsList.appendChild(ecard);
				} finally {
					submitBtn.disabled = false;
					submitBtn.textContent = 'Enviar';
					// safety: hide loading if something prevented hide earlier
					setTimeout(()=>{ const overlay = document.getElementById('loadingOverlay'); if (overlay) overlay.classList.add('hidden'); }, 5000);
				}
			});
		</script>
	</body>
</html>

